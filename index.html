<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Repro case</title>
</head>

<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
</body>

<script>
    const sqlite3 = require('sqlite3');

    // it('scheduling after the database was closed', function(done) {
    {
        const db = new sqlite3.Database(':memory:');
        db.on('error', function (err) {
            const ok = err.message && err.message.indexOf("SQLITE_MISUSE: Database handle is closed") > -1;
            console.log(err)
            if (!ok) throw err
        });

        db.close();
        db.run("CREATE TABLE foo (id int)");
    }

    // it('scheduling a query with callback after the database was closed', function(done) {
    {
        const db = new sqlite3.Database(':memory:');
        db.on('error', function (err) {
            throw 'Event was accidentally triggered';
        });

        db.close();
        db.run("CREATE TABLE foo (id int)", function (err) {
            const ok = err.message && err.message.indexOf("SQLITE_MISUSE: Database handle is closed") > -1;
            console.log(err)
            if (!ok) throw err
        });
    }
    // it('running a query after the database was closed', function(done) {
    {
        const db = new sqlite3.Database(':memory:');
        const stmt = db.prepare("SELECT * FROM sqlite_master", function (err) {
            if (err) throw err;
            db.close(function (err) {
                const ok = err.message && err.message.indexOf("SQLITE_BUSY: unable to close due to") > -1;
                console.log(err)
                if (!ok) throw err
                // Running a statement now should not fail.
                stmt.run(console.log);
            });
        });
    }
</script>

</html>